!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.eventTracking=t()}(this,function(){var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},o=App,r=Page,a=Component,i=function(){function n(t){var i=this;e(this,n),this.injectPageMethods=[],this.injectAppMethods=[],this.extraPageMethods=[],this.extraAppMethods=[],this.injectComponentMethods=[],this.extraComponentMethods=[],t||(App=function(e){return o(i._create(e,i.injectAppMethods,i.extraAppMethods))},Page=function(e){return r(i._create(e,i.injectPageMethods,i.extraPageMethods))},Component=function(e){return a(i._createComponent(e,i.injectComponentMethods,i.extraComponentMethods))})}return t(n,[{key:"_wrapTargetMethod",value:function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=e[n];e[n]=function(){for(var a=this,i=arguments.length,c=Array(i),u=0;u<i;u++)c[u]=arguments[u];var s=r&&r.apply(this,c),h=function(){o.forEach(function(o){o.apply(a,[e,t,n].concat(c))})};try{"[object Promise]"===Object.prototype.toString.call(s)?s.then(function(){h()}).catch(function(){h()}):h()}catch(e){console.error(n,"钩子函数执行出现错误",e)}return s}}},{key:"_addExtraMethod",value:function(e,t){t.forEach(function(t){var n=t.name;e[n]=t})}},{key:"_create",value:function(e,t,n){var o=this;return Object.keys(e).filter(function(t){return"function"==typeof e[t]}).forEach(function(n){o._wrapTargetMethod(e,null,n,t)}),this._addExtraMethod(e,n),e}},{key:"_createComponent",value:function(e,t,n){var o=this,r=e.methods;return Object.keys(r).filter(function(e){return"function"==typeof r[e]}).forEach(function(n){o._wrapTargetMethod(r,e,n,t)}),this._addExtraMethod(r,n),e}},{key:"addPageMethodWrapper",value:function(e){this.injectPageMethods.push(e)}},{key:"addComponentMethodWrapper",value:function(e){this.injectComponentMethods.push(e)}},{key:"addAppMethodWrapper",value:function(e){this.injectAppMethods.push(e)}},{key:"addPageMethodExtra",value:function(e){this.extraPageMethods.push(e)}},{key:"addAppMethodExtra",value:function(e){this.extraAppMethods.push(e)}},{key:"createApp",value:function(e){o(this._create(e,this.injectAppMethods,this.extraAppMethods))}},{key:"createPage",value:function(e){r(this._create(e,this.injectPageMethods,this.extraPageMethods))}},{key:"createComponent",value:function(e){r(this._createComponent(e,this.injectPageMethods,this.extraPageMethods))}}]),n}(),c=function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}},u=require("../../utils/apis.js"),s=(getApp(),function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2],o=t.index,r=e.split("."),a=n;return r.length>-1?r.forEach(function(e){var t=function(e,t){var n=e.indexOf("["),o=e.indexOf("]"),r={};if(n>-1){var a=e.substring(n+1,o),i=e.substring(0,n);"$INDEX"===a&&(a=t),r.key=i,r.index=parseInt(a,10)}return r}(e,o);a=t.key?a[t.key][t.index]:a[e]}):a=n[e],a}),h=function(e,t,n){try{return 0===e.indexOf("$")?function(e,t){var n="";e.indexOf("$APP.")>-1?n=getApp()[e.split("$APP.")[1]]:e.indexOf("$DATASET.")>-1?n=t[e.split("$DATASET.")[1]]:e.indexOf("$INDEX")>-1&&(n=t.index);return n}(e,t):s(e,t,n)}catch(e){return console.log(e),""}},f=function(e,t){var n=e.element,o=e.method,r=[];e.dataKeys.forEach(function(a){var i=h(a,e.dataset,t);r.push({element:n,method:o,name:a,data:i})}),console.table(r);var a={logList:r,userInfo:wx.getStorageSync("userInfo")};wx.request({url:u.logUrl,method:"POST",data:a,header:u.jsonHead,success:function(e){console.log(e)},fail:function(e){console.log(e)}})};return function(o){function r(t){var o=t.tracks,a=t.isUsingPlugin;e(this,r);var i=n(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,a));return i.tracks=o,i.addPageMethodExtra(i.elementTracker()),i.addPageMethodWrapper(i.methodTracker()),i.addComponentMethodWrapper(i.comMethodTracker()),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(r,i),t(r,[{key:"elementTracker",value:function(){var e=this,t=function(t){var n=e.findActivePageTracks("element"),o=c().data;n.forEach(function(e){var n;(n=e.element,new Promise(function(e){var t=wx.createSelectorQuery();t.selectAll(n).boundingClientRect(),t.selectViewport().scrollOffset(),t.exec(function(t){return e({boundingClientRect:t[0],scrollOffset:t[1]})})})).then(function(n){n.boundingClientRect.forEach(function(r){var a=function(e,t,n){if(!t)return!1;var o=e.detail,r=o.x,a=o.y,i=t.left,c=t.right,u=t.top,s=t.height,h=n.scrollTop;return i<r&&r<c&&h+u<a&&a<h+u+s}(t,r,n.scrollOffset);e.dataset=r.dataset,a&&f(e,o)})})})};return t}},{key:"methodTracker",value:function(){var e=this;return function(t,n,o){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=e.findActivePageTracks("method"),i=c().data,u=(r.currentTarget||{}).dataset;a.forEach(function(e){e.method===o&&(e.dataset=u,f(e,i))})}}},{key:"comMethodTracker",value:function(){var e=this;return function(t,n,o){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=e.findActivePageTracks("comMethod"),i=this.data,c=(r.currentTarget||{}).dataset;a.forEach(function(e){e.method===o&&(e.dataset=c,f(e,i))})}}},{key:"findActivePageTracks",value:function(e){try{var t=c().route,n=this.tracks.find(function(e){return e.path===t})||{},o={};return"method"===e?o=n.methodTracks||[]:"element"===e?o=n.elementTracks||[]:"comMethod"===e&&(o=n.comMethodTracks||[]),o}catch(e){return{}}}}]),r}()});
